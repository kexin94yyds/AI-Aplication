# 文字注入功能使用指南

## 功能说明

文字注入功能允许你在任意应用中选中文字后，通过快捷键自动将文字注入到 AI Sidebar 的输入框中。

## 使用方法

### 基本流程

1. **在任意应用中选中文字**（浏览器、编辑器、文档等）
2. **按下快捷键**：
   - macOS: `Command + Shift + Y`
   - Windows/Linux: `Control + Shift + Y`
3. **自动执行**：
   - 系统会自动复制选中的文字
   - AI Sidebar 窗口会自动显示（如果隐藏）
   - 文字会自动注入到当前 AI 提供商的输入框中

### 使用场景

- ✅ **全局使用**：在应用外选中文字 → 按快捷键 → 文字注入到 Sidebar
- ✅ **应用内使用**：在 Sidebar 的 BrowserView 中选中文字 → 按快捷键 → 文字注入到输入框
- ✅ **手动复制后使用**：先复制文字（Cmd/Ctrl+C）→ 按快捷键 → 文字注入

## macOS 权限配置（必须）

在 macOS 上，为了让应用能够自动复制选中的文字，**必须授予辅助功能权限**。

### 设置步骤

1. 打开 **系统设置**
2. 进入 **隐私与安全性**
3. 点击 **辅助功能**
4. 在列表中找到 **AI Sidebar**
5. 勾选启用该应用

### 权限说明

- **为什么需要这个权限？** 辅助功能权限允许应用模拟键盘操作（Cmd+C），从而自动复制选中的文字
- **安全性：** 应用只会在你按下快捷键时才执行复制操作，不会在后台自动执行

### 如果没有授予权限会怎样？

- 你仍然可以**手动复制文字**（Cmd+C），然后按快捷键注入
- 但无法直接选中文字后立即按快捷键注入

## 技术实现

### 工作流程

1. **快捷键触发** → 全局快捷键监听器捕获
2. **保存旧剪贴板内容** → 避免覆盖用户的剪贴板
3. **模拟系统复制** → 通过 AppleScript/PowerShell 执行 Cmd+C 或 Ctrl+C
4. **等待 300ms** → 给系统足够时间完成复制操作
5. **读取剪贴板** → 获取选中的文字
6. **显示窗口** → 如果窗口隐藏，先显示出来
7. **查找输入框** → 在当前 BrowserView 中查找输入元素
8. **注入文字** → 将文字插入到输入框中

### 输入框识别策略

系统会按以下优先级查找输入框：

1. `textarea` 元素
2. `div[contenteditable="true"]` 元素
3. `[role="textbox"]` 元素
4. 包含 "prompt" 的 `aria-label` 元素
5. 包含 "prompt" 的 `data-testid` 元素

### 文字注入方式

- **textarea 元素**：直接设置 `value` 属性
- **contenteditable 元素**：使用 `document.execCommand('insertText')` 插入

## 故障排除

### 问题：按快捷键后没有反应

**可能原因：**
1. 快捷键被其他应用占用
2. 没有选中文字
3. macOS 未授予辅助功能权限

**解决方法：**
1. 检查是否有其他应用使用了相同的快捷键
2. 确保选中了文字
3. 检查辅助功能权限设置

### 问题：文字无法注入到输入框

**可能原因：**
1. 当前页面没有可识别的输入框
2. 输入框被动态加载，尚未出现

**解决方法：**
1. 等待页面完全加载后再试
2. 手动点击输入框，然后手动粘贴（Cmd/Ctrl+V）

### 问题：注入的是旧内容，不是刚选中的文字

**可能原因：**
1. 等待时间不够（网络延迟或系统负载高）
2. 复制操作失败

**解决方法：**
1. 先手动复制（Cmd/Ctrl+C），然后按快捷键
2. 检查辅助功能权限是否已授予

## 日志调试

如果遇到问题，可以查看控制台日志：

1. 启动应用时添加 `--dev` 参数：
   ```bash
   open -a "AI Sidebar" --args --dev
   ```

2. 查看日志输出：
   - `文字选择快捷键触发` - 快捷键被成功触发
   - `成功获取选中文字: X 字符` - 成功读取剪贴板
   - `准备插入文字到输入框` - 开始插入文字
   - `文字插入成功` - 文字成功注入
   - `模拟复制失败（可能需要辅助功能权限）` - 权限问题

## 更新日志

### v1.1.0 (当前版本)

**改进：**
- ✨ 增加了等待时间（从 140ms 提升到 300ms）
- ✨ 改进了剪贴板检测逻辑
- ✨ 添加了详细的错误提示
- ✨ 优化了窗口显示和文字注入的时序
- 📝 添加了更详细的权限说明和使用指南

**修复：**
- 🐛 修复了在应用内选中文字后无法注入的问题
- 🐛 修复了 AppleScript 引号转义问题
- 🐛 改进了输入框查找逻辑

## 反馈

如果你遇到任何问题或有改进建议，请：
1. 查看控制台日志
2. 记录复现步骤
3. 提交 Issue 或联系开发者


